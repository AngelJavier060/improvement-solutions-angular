<div class="container-fluid p-4">
  <!-- Botón de cerrar -->
  <!-- Botón de cerrar eliminado, solo se usa el del header superior -->

  <div *ngIf="showHeader" class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h4 class="mb-1 text-primary" style="font-weight: 500;">
        <i class="fas fa-chart-line me-2"></i>Dashboard de Cumplimiento
      </h4>
      <small class="text-muted">Empresa: {{ business?.name || 'Cargando...' }}</small>
    </div>
  </div>

  <!-- Loading -->
  <div class="text-center py-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <div class="mt-2 text-muted">Cargando datos del dashboard...</div>
  </div>

  <!-- Error -->
  <div class="alert alert-danger" *ngIf="error && !loading">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!loading && !error && business">
    <!-- Información de la empresa -->
    <div class="card shadow-sm border-0 mb-4" *ngIf="showCompanyInfo">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Información de la Empresa</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <strong>RUC:</strong> {{ business.ruc }}
          </div>
          <div class="col-md-3">
            <strong>Razón Social:</strong> {{ business.name }}
          </div>
          <div class="col-md-3">
            <strong>Tipo:</strong> {{ business.businessType }}
          </div>
          <div class="col-md-3">
            <strong>Estado:</strong> {{ business.status }}
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas de personal -->
    <div class="card shadow-sm border-0 mb-4" *ngIf="showEmployeeStats">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Estadísticas de Personal</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-2">
            <div class="h4 text-primary">{{ employeeStats.total }}</div>
            <small class="text-muted">Total</small>
          </div>
          <div class="col-md-2">
            <div class="h4 text-info">{{ employeeStats.hombres }}</div>
            <small class="text-muted">Hombres</small>
          </div>
          <div class="col-md-2">
            <div class="h4 text-danger">{{ employeeStats.mujeres }}</div>
            <small class="text-muted">Mujeres</small>
          </div>
          <div class="col-md-2">
            <div class="h4 text-warning">{{ employeeStats.discapacidad }}</div>
            <small class="text-muted">Discapacidad</small>
          </div>
          <div class="col-md-2">
            <div class="h4 text-secondary">{{ employeeStats.adolescentes }}</div>
            <small class="text-muted">Adolescentes</small>
          </div>
          <div class="col-md-2">
            <div class="h4 text-success">{{ employeeStats.total - employeeStats.adolescentes }}</div>
            <small class="text-muted">Adultos</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4" *ngIf="showGauge || showAgeBar">
      <!-- Gráfico Gauge -->
      <div class="col-md-6" *ngIf="showGauge">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Cumplimiento General</h5>
              <div class="small fw-semibold">
                {{ summaryCompleted }}/{{ summaryTotal }} ({{ summaryPercentage | number:'1.0-1' }}%)
              </div>
            </div>
          </div>
          <div class="card-body d-flex justify-content-center align-items-center">
            <div echarts [options]="gaugeOptions" class="w-100" style="height: 300px;"></div>
          </div>
        </div>
      </div>

      <!-- Gráfico de Barras -->
      <div class="col-md-6" *ngIf="showAgeBar">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-warning text-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Rango de edades</h5>
          </div>
          <div class="card-body">
            <div echarts [options]="barOptions" class="w-100" style="height: 300px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección Legal -->
    <div class="card shadow-sm border-0" *ngIf="showLegalSection">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-gavel me-2"></i>Resumen Legal</h5>
      </div>
      <div class="card-body p-0">
        <!-- Mensaje cuando no hay datos -->
        <div class="text-center py-4" *ngIf="complianceData.length === 0">
          <div class="text-muted">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <div>No hay requisitos legales registrados para esta empresa.</div>
            <small>Los datos se mostrarán una vez que se configuren las obligaciones legales.</small>
          </div>
        </div>

        <!-- Tabla cuando hay datos -->
        <div class="table-responsive" *ngIf="complianceData.length > 0">
          <table class="table table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th class="px-3">#</th>
                <th><i class="fas fa-gavel me-1"></i>Cumplimiento Legal</th>
                <th class="d-none d-lg-table-cell"><i class="fas fa-book me-1"></i>Regulación</th>
                <th><i class="fas fa-calendar-plus me-1"></i>Fecha ingreso</th>
                <th><i class="fas fa-clock me-1"></i>Días vigencia</th>
                <th><i class="fas fa-info-circle me-1"></i>Estado</th>
                <th><i class="fas fa-exclamation-triangle me-1"></i>Prioridad</th>
                <th class="text-center"><i class="fas fa-file-pdf me-1"></i>Documento</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of complianceData; let i = index">
                <td class="px-3">{{ i + 1 }}</td>
                <td>
                  <div style="font-weight: 500;">{{ item?.name || item?.obligationMatrix?.legalCompliance || '—' }}</div>
                </td>
                <td class="d-none d-lg-table-cell">
                  {{ item?.obligationMatrix?.legalRegulation || '—' }}
                </td>
                <td>
                  {{ item?.createdAt ? (item.createdAt | date) : '—' }}
                </td>
                <td>
                  <span class="badge" [ngClass]="getDaysBadgeClass(calculateDaysRemaining(item))">
                    <i class="fas" [ngClass]="calculateDaysRemaining(item) < 0 ? 'fa-exclamation-triangle' : 'fa-clock'"></i>
                    {{ getDaysLabel(calculateDaysRemaining(item)) }}
                  </span>
                </td>
                <td>
                  <span class="soft-badge"
                    [ngClass]="{
                      'status-pendiente': getDisplayStatus(item) === 'PENDIENTE',
                      'status-cumplido': getDisplayStatus(item) === 'CUMPLIDO',
                      'status-vencida': getDisplayStatus(item) === 'VENCIDA',
                      'status-enproceso': getDisplayStatus(item) === 'EN PROCESO'
                    }">
                    <i class="fas me-1" [ngClass]="getStatusIcon(getDisplayStatus(item))"></i>
                    {{ getDisplayStatus(item) }}
                  </span>
                </td>
                <td>
                  <span class="soft-badge"
                    [ngClass]="{
                      'priority-alta': (item?.priority || 'MEDIA').toUpperCase() === 'ALTA',
                      'priority-media': (item?.priority || 'MEDIA').toUpperCase() === 'MEDIA',
                      'priority-baja': (item?.priority || 'MEDIA').toUpperCase() === 'BAJA'
                    }">
                    <i class="fas me-1" [ngClass]="getPriorityIcon(item?.priority)"></i>
                    {{ item?.priority || 'MEDIA' }}
                  </span>
                </td>
                <td class="text-center">
                  <button class="btn btn-link btn-sm" (click)="previewLatestPdf(item)" [disabled]="pdfLoadingMap[item?.id]" title="Ver PDF vigente">
                    <i class="fas" [ngClass]="pdfLoadingMap[item?.id] ? 'fa-spinner fa-spin' : 'fa-eye'"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
