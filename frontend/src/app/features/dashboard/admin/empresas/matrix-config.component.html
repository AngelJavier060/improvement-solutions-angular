<div class="container-fluid p-4">
   <div class="d-flex align-items-center justify-content-between mb-4">
     <div>
       <h4 class="mb-1 text-primary" style="font-weight: 500;">
         <i class="fas fa-balance-scale me-2"></i>Configuración matriz legal
       </h4>
       <small class="text-muted">Empresa #{{ businessId }}</small>
     </div>
     <a class="btn btn-outline-secondary btn-sm" [routerLink]="['/dashboard','admin','empresas','admin', businessId]">
       <i class="fas fa-arrow-left me-1"></i> Volver a Empresa
     </a>
   </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="text-center py-5" *ngIf="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <div class="mt-2 text-muted">Cargando matriz legal...</div>
      </div>
      <div class="alert alert-danger" *ngIf="error && !loading">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
      </div>
      <div class="alert alert-info" *ngIf="!loading && !error && items.length === 0">
        <i class="fas fa-info-circle me-2"></i>No hay requisitos legales asignados a esta empresa.
      </div>

      <div class="table-responsive" *ngIf="!loading && !error && items.length > 0">
        <table class="table table-hover mb-0 shadow-sm">
          <thead class="table-primary">
          <tr style="font-weight: 500;">
            <th class="px-3">#</th>
            <th><i class="fas fa-gavel me-1"></i>Cumplimiento Legal</th>
            <th class="d-none d-lg-table-cell"><i class="fas fa-book me-1"></i>Regulación Legal</th>
            <th><i class="fas fa-calendar-plus me-1"></i>Fecha ingreso</th>
            <th><i class="fas fa-calendar-times me-1"></i>Fecha vencimiento</th>
            <th class="d-none d-md-table-cell"><i class="fas fa-clock me-1"></i>Días vigencia</th>
            <th class="d-none d-lg-table-cell"><i class="fas fa-exclamation-triangle me-1"></i>Prioridad</th>
            <th><i class="fas fa-sticky-note me-1"></i>Observación</th>
            <th class="text-center"><i class="fas fa-paperclip me-1"></i>Archivos</th>
            <th class="d-none d-md-table-cell"><i class="fas fa-info-circle me-1"></i>Estado</th>
            <th class="text-center"><i class="fas fa-cogs me-1"></i>Acciones</th>
            <th class="d-none d-md-table-cell"><i class="fas fa-info-circle me-1"></i>Estado</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let item of items; let i = index">
            <td class="px-3">{{ i + 1 }}</td>
            <td>
              <ng-container *ngIf="!isEditing(item); else editName">
                <div class="d-flex align-items-center gap-2" style="font-weight: 500;">
                  <span class="badge bg-info-subtle text-info">v{{ item?.currentVersion || 1 }}</span>
                  <span>{{ resolveName(item) }}</span>
                </div>
              </ng-container>
              <ng-template #editName>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="editModel[item.id].name" placeholder="Cumplimiento Legal" />
              </ng-template>
            </td>
            <td class="d-none d-lg-table-cell">
              <ng-container *ngIf="!isEditing(item); else editRegulation">
                {{ resolveRegulation(item) }}
              </ng-container>
              <ng-template #editRegulation>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="editModel[item.id].legalRegulation" placeholder="Regulación Legal" />
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="!isEditing(item); else editStart">
                {{ item?.createdAt ? formatDate(item?.createdAt) : '—' }}
              </ng-container>
              <ng-template #editStart>
                <input type="date" class="form-control form-control-sm" [(ngModel)]="editModel[item.id].startDate" [value]="editModel[item.id].startDate" />
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="!isEditing(item); else editDueDate">
                {{ item?.dueDate ? formatDate(item?.dueDate) : '—' }}
              </ng-container>
              <ng-template #editDueDate>
                <input type="date" class="form-control form-control-sm" [(ngModel)]="editModel[item.id].dueDate" [value]="toDateInputValue(editModel[item.id].dueDate)">
              </ng-template>
            </td>
            <td class="d-none d-md-table-cell">
              <span class="badge" [ngClass]="daysBadgeClass(calculateDaysRemaining(item))">
                <i class="fas" [ngClass]="calculateDaysRemaining(item) < 0 ? 'fa-exclamation-triangle' : 'fa-clock'"></i>
                {{ displayDaysLabel(calculateDaysRemaining(item)) }}
              </span>
            </td>
            <td class="d-none d-lg-table-cell">
              <ng-container *ngIf="!isEditing(item); else editPriority">
                  <span class="soft-badge"
                    [ngClass]="{
                      'priority-alta': (item?.priority || 'MEDIA').toUpperCase() === 'ALTA',
                      'priority-media': (item?.priority || 'MEDIA').toUpperCase() === 'MEDIA',
                      'priority-baja': (item?.priority || 'MEDIA').toUpperCase() === 'BAJA'
                    }">
                    <i class="fas me-1" [ngClass]="getPriorityIcon(item?.priority)"></i>
                    {{ item?.priority || 'MEDIA' }}
                  </span>
              </ng-container>
              <ng-template #editPriority>
                <select class="form-select form-select-sm" [(ngModel)]="editModel[item.id].priority">
                  <option [ngValue]="undefined">—</option>
                  <option *ngFor="let p of priorityOptions" [ngValue]="p">{{ p }}</option>
                </select>
              </ng-template>
            </td>
            <td style="min-width:180px;max-width:280px;">
              <ng-container *ngIf="!isEditing(item); else editObs">
                  <div class="soft-observacion text-truncate" title="{{ item?.observations }}">{{ item?.observations || '—' }}</div>
              </ng-container>
              <ng-template #editObs>
                <textarea class="form-control form-control-sm" rows="2" [(ngModel)]="editModel[item.id].observations" placeholder="Observaciones"></textarea>
              </ng-template>
            </td>
            <td class="text-center">
              <button class="btn btn-link btn-sm" (click)="toggleFiles(item?.id)" title="Mostrar archivos">
                <i class="fas fa-paperclip me-1"></i>{{ fileCountMap[item?.id] || 0 }}
              </button>
              <div *ngIf="openRows[item?.id]" class="mt-2 text-start">
                <div *ngIf="filesLoading[item?.id]" class="text-muted small">
                  <i class="fas fa-spinner fa-spin me-1"></i> Cargando archivos...
                </div>
                <ul class="list-unstyled small mb-2" *ngIf="!filesLoading[item?.id] && (fileCountMap[item?.id]||0) > 0">
                  <li *ngFor="let f of filesMap[item?.id]" class="d-flex align-items-center justify-content-between py-1 border-bottom">
                    <div class="me-2 text-truncate d-flex align-items-center" title="{{ displayFileName(f) }}">
                      <i class="fas me-1" [ngClass]="getFileIcon(displayFileName(f))"></i>
                      {{ displayFileName(f) }}
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm" (click)="previewFile(f)" title="Ver archivo">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="downloadFile(f)" title="Descargar archivo">
                        <i class="fas fa-download"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteFile(f, item)" title="Eliminar archivo">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </li>
                </ul>
                <!-- Subir archivos -->
                <div class="d-flex align-items-center gap-2 mb-2">
                  <input type="file" class="d-none" accept="application/pdf,.pdf,application/msword,.doc,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.docx" [id]="'file-'+item?.id" (change)="onFileSelected(item, $event)" />
                  <label class="btn btn-sm btn-outline-primary" [for]="'file-'+item?.id" title="Subir PDF o documento Word">
                    <i class="fas fa-upload me-1"></i> Subir archivo
                  </label>
                </div>

                <!-- Historial de versiones -->
                <div class="mt-2">
                  <button class="btn btn-link btn-sm" (click)="toggleHistory(item?.id)">
                    <i class="fas" [ngClass]="historyOpen[item?.id] ? 'fa-chevron-down' : 'fa-history'"></i>
                    {{ historyOpen[item?.id] ? 'Ocultar historial' : 'Ver historial' }}
                  </button>
                  <div *ngIf="historyOpen[item?.id]" class="mt-2">
                    <div *ngIf="versionsLoading[item?.id]" class="text-muted small">
                      <i class="fas fa-spinner fa-spin me-1"></i> Cargando historial...
                    </div>
                    <div *ngIf="!versionsLoading[item?.id] && (versionsMap[item?.id]?.length || 0) === 0" class="text-muted small">
                      No hay versiones previas registradas.
                    </div>
                    <ul class="list-unstyled small" *ngIf="!versionsLoading[item?.id] && (versionsMap[item?.id]?.length || 0) > 0">
                      <li *ngFor="let v of versionsMap[item?.id]" class="py-1 border-bottom">
                        <div class="d-flex align-items-center justify-content-between">
                          <div>
                            <strong>Versión {{ v?.version }}</strong>
                            <span class="text-muted ms-2">{{ formatDateTime(v?.createdAt) }}</span>
                          </div>
                          <div>
                            <button class="btn btn-outline-secondary btn-sm" (click)="loadVersionFiles(item?.id, v?.version)">
                              <i class="fas fa-paperclip me-1"></i>Ver archivos
                            </button>
                          </div>
                        </div>
                        <div *ngIf="versionFilesMap[item?.id]?.[v?.version] as vf">
                          <div class="mt-1 ps-3" *ngIf="versionFilesLoading[item?.id + ':' + v?.version]">
                            <i class="fas fa-spinner fa-spin me-1"></i> Cargando archivos de versión...
                          </div>
                          <ul class="list-unstyled mt-1 ps-3" *ngIf="!versionFilesLoading[item?.id + ':' + v?.version] && (vf?.length || 0) > 0">
                            <li *ngFor="let f2 of vf" class="d-flex align-items-center justify-content-between py-1">
                              <div class="me-2 text-truncate">
                                <i class="fas me-1" [ngClass]="getFileIcon(displayFileName(f2))"></i>
                                {{ displayFileName(f2) }}
                              </div>
                              <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" (click)="previewFile(f2)" title="Ver archivo">
                                  <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" (click)="downloadFile(f2)" title="Descargar archivo">
                                  <i class="fas fa-download"></i>
                                </button>
                              </div>
                            </li>
                          </ul>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <ng-container *ngIf="!isEditing(item); else editCompleted">
                <span class="soft-badge" [ngClass]="item?.completed ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'">
                  <i class="fas me-1" [ngClass]="item?.completed ? 'fa-check-circle' : 'fa-pause-circle'"></i>
                  {{ item?.completed ? 'CUMPLIDO' : 'PENDIENTE' }}
                </span>
              </ng-container>
              <ng-template #editCompleted>
                <select class="form-select form-select-sm" [(ngModel)]="editModel[item.id].completed">
                  <option [ngValue]="false">PENDIENTE</option>
                  <option [ngValue]="true">CUMPLIDO</option>
                </select>
              </ng-template>
            </td>
            <td class="text-center">
              <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
                <button class="btn btn-sm" [ngClass]="isEditing(item) ? 'btn-success' : 'btn-outline-primary'" (click)="isEditing(item) ? saveRow(item) : startEdit(item)">
                  <i class="fas" [ngClass]="isEditing(item) ? 'fa-save' : 'fa-edit'"></i>
                  {{ isEditing(item) ? 'Guardar' : 'Editar' }}
                </button>
                <button *ngIf="isEditing(item)" class="btn btn-sm btn-outline-secondary" (click)="cancelEdit(item)">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-sm btn-outline-success" (click)="openRenew(item)" title="Renovar (nueva versión)">
                  <i class="fas fa-sync-alt"></i> Renovar
                </button>
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <span class="soft-badge" [ngClass]="statusBadgeClass(item)">
                <i class="fas me-1" [ngClass]="getStatusIcon(displayStatus(item))"></i>
                {{ displayStatus(item) }}
              </span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Renovación -->
<div *ngIf="renewVisible" class="modal-backdrop fade show" style="display:block;"></div>
<div *ngIf="renewVisible" class="modal d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title mb-0">Renovar requisito legal</h6>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeRenew()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label small mb-1">Cumplimiento Legal</label>
            <input type="text" class="form-control form-control-sm" [(ngModel)]="renewModel.name" />
          </div>
          <div class="col-12">
            <label class="form-label small mb-1">Regulación Legal</label>
            <input type="text" class="form-control form-control-sm" [(ngModel)]="renewModel.legalRegulation" />
          </div>
          <div class="col-md-6">
            <label class="form-label small mb-1">Fecha ingreso</label>
            <input type="date" class="form-control form-control-sm" [(ngModel)]="renewModel.startDate" />
          </div>
          <div class="col-md-6">
            <label class="form-label small mb-1">Fecha vencimiento</label>
            <input type="date" class="form-control form-control-sm" [(ngModel)]="renewModel.dueDate" />
          </div>
          <div class="col-md-6">
            <label class="form-label small mb-1">Prioridad</label>
            <select class="form-select form-select-sm" [(ngModel)]="renewModel.priority">
              <option [ngValue]="'ALTA'">ALTA</option>
              <option [ngValue]="'MEDIA'">MEDIA</option>
              <option [ngValue]="'BAJA'">BAJA</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label small mb-1">Observaciones</label>
            <textarea class="form-control form-control-sm" rows="2" [(ngModel)]="renewModel.observations"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button class="btn btn-secondary btn-sm" (click)="closeRenew()">Cancelar</button>
        <button class="btn btn-success btn-sm" (click)="confirmRenew()">Confirmar renovación</button>
      </div>
    </div>
  </div>
  </div>
