<!-- Layout profesional y moderno -->
<div class="container-fluid p-4" *ngIf="!loading && empresa">

  
  
  <!-- Header de la empresa con diseño profesional -->
  <div class="card shadow-lg border-0 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body text-white">
      <div class="row align-items-center">
        <div class="col-auto">
          <div class="position-relative">
            <img 
              [src]="getLogoUrl()" 
              [alt]="'Logo ' + empresa.name"
              class="rounded-circle border border-white border-3 shadow"
              style="width: 100px; height: 100px; object-fit: cover;"
              onerror="this.src='/assets/img/user-placeholder.svg'">
            <span class="position-absolute bottom-0 end-0 badge bg-success rounded-pill">
              <i class="fas fa-check"></i>
            </span>
          </div>
        </div>
        <div class="col flex-grow-1 px-4">
          <div class="mb-2">
            <h2 class="mb-1 fw-bold display-6">{{ empresa.name }}</h2>
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-id-card me-2"></i>
              <span class="h5 mb-0 opacity-75">RUC: {{ empresa.ruc }}</span>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge bg-light text-dark px-3 py-2">
                <i class="fas fa-building me-1"></i>Empresa Activa
              </span>
              <span class="badge bg-success px-3 py-2">
                <i class="fas fa-shield-alt me-1"></i>Verificada
              </span>
            </div>
          </div>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-light btn-lg" (click)="openEditEmpresaModal()" title="Editar empresa">
            <i class="fas fa-edit me-2"></i>Editar
          </button>
        </div>
      </div>
      
      <!-- Panel de información expandida -->
      <div class="row mt-4 pt-4 border-top border-light border-opacity-25">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-user-tie text-dark" style="font-size: 18px;"></i>
              </div>
            </div>
            <div>
              <small class="text-white-50 d-block">REPRESENTANTE LEGAL</small>
              <strong>{{ empresa.legalRepresentative || 'No especificado' }}</strong>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-envelope text-dark" style="font-size: 18px;"></i>
              </div>
            </div>
            <div>
              <small class="text-white-50 d-block">EMAIL</small>
              <strong>{{ empresa.email || 'No especificado' }}</strong>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-map-marker-alt text-dark" style="font-size: 18px;"></i>
              </div>
            </div>
            <div>
              <small class="text-white-50 d-block">DIRECCIÓN</small>
              <strong>{{ empresa.address || 'No especificado' }}</strong>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-phone text-dark" style="font-size: 18px;"></i>
              </div>
            </div>
            <div>
              <small class="text-white-50 d-block">TELÉFONO</small>
              <strong>{{ empresa.phone || 'No especificado' }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Grid responsivo para las secciones de configuración -->
  <div class="row g-2 mb-4">
    <!-- 1. Sección Departamentos -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.departments?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-building text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Departamentos</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-warning btn-sm w-100" (click)="openAsignDepartmentModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
          
          <div *ngIf="empresa.departments?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let dept of empresa.departments">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-building text-warning me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ dept | name:'department' }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1"
                          title="Editar"
                          (click)="editDepartment(dept)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          title="Eliminar" 
                          (click)="removeDepartment(dept.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

 

          <div *ngIf="empresa.departments?.length === 0" class="text-center py-2">
            <i class="fas fa-building fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin departamentos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Sección Gestión de documentos personales -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.type_documents?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-file-alt text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Documentos personales</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-primary btn-sm w-100" (click)="openAsignDocumentModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
          
          <div *ngIf="empresa.type_documents?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let doc of empresa.type_documents">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-file-text text-primary me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ doc | name:'type_document' }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" 
                          title="Editar" 
                          (click)="editDocument(doc)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          title="Eliminar" 
                          (click)="removeDocument(doc.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.type_documents?.length === 0" class="text-center py-2">
            <i class="fas fa-file-alt fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin documentos personales</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2b. Sección Cursos y certificaciones -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.course_certifications?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #34d399 0%, #10b981 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-certificate text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Cursos y certificaciones</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-success btn-sm w-100" (click)="openAsignCourseCertModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>

          <div *ngIf="empresa.course_certifications?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let cc of empresa.course_certifications">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-certificate text-success me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ cc.name || cc.title || cc.description || ('#' + cc.id) }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1"
                          title="Editar"
                          (click)="editCourseCert(cc)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1"
                          title="Eliminar"
                          (click)="removeCourseCert(cc.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.course_certifications?.length === 0" class="text-center py-2">
            <i class="fas fa-certificate fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin cursos/certificaciones</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2c. Sección Tarjetas -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.cards?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-id-badge text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Tarjetas</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-warning btn-sm w-100" (click)="openAsignCardModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>

          <div *ngIf="empresa.cards?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let card of empresa.cards">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-id-badge text-warning me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ card.name || card.title || card.description || ('#' + card.id) }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1"
                          title="Editar"
                          (click)="editCard(card)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1"
                          title="Eliminar"
                          (click)="removeCard(card.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.cards?.length === 0" class="text-center py-2">
            <i class="fas fa-id-badge fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin tarjetas</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Sección Cargos -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.positions?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-briefcase text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Cargos</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-info btn-sm w-100" (click)="openAsignCargoModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
          
          <div *ngIf="empresa.positions?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let cargo of empresa.positions">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-user-tie text-info me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ cargo | name:'position' }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" 
                          title="Editar" 
                          (click)="editCargo(cargo)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          title="Eliminar" 
                          (click)="removeCargo(cargo.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.positions?.length === 0" class="text-center py-2">
            <i class="fas fa-briefcase fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin cargos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Sección Gestionar seguros IESS -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.ieses?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-shield-alt text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">IESS</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-info btn-sm w-100" (click)="openAsignIessModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
          
          <div *ngIf="empresa.ieses && empresa.ieses.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let ies of empresa.ieses; trackBy: trackByIessId">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-shield-check text-info me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ ies.description || ies.name || 'IESS #' + ies.id }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" (click)="editIess(ies)" title="Editar" style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" (click)="removeIess(ies.id)" title="Eliminar" style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.ieses?.length === 0" class="text-center py-2">
            <i class="fas fa-shield-alt fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin seguros IESS</p>
            <!-- DEBUG: Información simplificada -->
            <div class="mt-1" style="font-size: 8px; color: #666; background: #f8f9fa; padding: 3px; border-radius: 3px;">
              DEBUG: empresa.ieses={{empresa?.ieses?.length}} | iessList={{iessList.length}} | disponibles={{getAvailableIess().length}}
            </div>
          </div>

          <!-- Botón explícito para guardar cambios de IESS -->
          <div class="text-end mt-2">
            <button class="btn btn-primary btn-sm" (click)="saveIessChanges()">
              <i class="fas fa-save me-1"></i>Guardar cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. Sección Gestionar obligaciones legales -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.obligation_matrices?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #ff7b54 0%, #ff9068 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-balance-scale text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Matriz Legal</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-warning btn-sm w-100" (click)="openAsignObligationModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
          <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <img *ngIf="qrPreviewToken && getQrImageUrl()" [src]="getQrImageUrl()" alt="QR" style="width:200px;height:200px;border:1px solid #eee;border-radius:6px;"/>
              <a *ngIf="qrPreviewToken && getQrPortalUrl()" [href]="getQrPortalUrl()" target="_blank" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-external-link-alt me-1"></i> Abrir portal QR
              </a>
              <button *ngIf="qrPreviewToken && getQrPortalUrl()" type="button" class="btn btn-outline-secondary btn-sm" (click)="copyQrUrl()">
                <i class="fas fa-copy me-1"></i> Copiar enlace
              </button>
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm" (click)="generateQrPreviewToken()">
                <i class="fas fa-qrcode me-1"></i> Generar vista previa
              </button>
            </div>
          </div>
          
          <div *ngIf="empresa.obligation_matrices?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let obligation of empresa.obligation_matrices; trackBy: trackById">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-gavel text-warning me-2" style="font-size: 10px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">
                      {{ obligation.name || obligation.obligationMatrix?.name }}
                    </div>
                    <div class="text-muted" style="font-size: 9px;">{{ obligation.obligationMatrix?.legalRegulation }}</div>
                    <div class="text-muted" style="font-size: 8px;">{{ obligation.description || obligation.obligationMatrix?.description }}</div>
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-success btn-sm p-1"
                          (click)="toggleLatestPublicOnRow(obligation)"
                          title="Mostrar/Ocultar público"
                          style="font-size: 8px;">
                    <i class="fas" [ngClass]="rowEyeIcon(obligation)"></i>
                  </button>
                  <button class="btn btn-outline-primary btn-sm p-1" (click)="replaceObligation(obligation)" title="Editar (reemplazar)" style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-secondary btn-sm p-1"
                          (click)="toggleMatrixFiles(obligation)"
                          title="Ver documentos"
                          style="font-size: 8px;">
                    <i class="fas fa-paperclip"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          (click)="removeObligation(obligation)" 
                          [disabled]="isDeletingObligation(obligation)"
                          title="Eliminar" 
                          style="font-size: 8px;">
                    <i class="fas" [ngClass]="isDeletingObligation(obligation) ? 'fa-spinner fa-spin' : 'fa-times'"></i>
                  </button>
                </div>
              </div>
              <!-- Archivos y pendientes -->
              <div class="mt-1 p-2 border rounded bg-white" *ngIf="matrixFilesVisible[getMatrixRelationId(obligation)]">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="small fw-bold">Archivos de matriz legal</div>
                  <div>
                    <input type="file" class="d-none" accept=".pdf,.doc,.docx" 
                           [id]="'upload-matrix-' + getMatrixRelationId(obligation)" 
                           (change)="uploadMatrixFile(obligation, $event)">
                    <label class="btn btn-sm btn-outline-primary p-1" 
                           [for]="'upload-matrix-' + getMatrixRelationId(obligation)" 
                           title="Subir archivo" style="font-size: 8px;">
                      <i class="fas fa-upload"></i>
                    </label>
                  </div>
                </div>
                <div class="text-muted small mb-1">Visibles para usuario (PDF): {{ countPublicFor(getMatrixRelationId(obligation)) }}/5</div>
                
                <div *ngIf="matrixFilesLoading[getMatrixRelationId(obligation)]" class="text-muted small">Cargando archivos...</div>
                <div *ngIf="!matrixFilesLoading[getMatrixRelationId(obligation)] && (matrixFiles[getMatrixRelationId(obligation)]?.length || 0) === 0" class="text-muted small">Sin archivos.</div>
                <div *ngFor="let f of (matrixFiles[getMatrixRelationId(obligation)] || [])" class="d-flex align-items-center justify-content-between py-1">
                  <div class="small">
                    {{ f.name || ('Archivo #' + f.id) }}
                    <span class="badge bg-success-subtle text-success ms-1" *ngIf="isPublicFile(f)"><i class="fas fa-eye me-1"></i>Visible</span>
                  </div>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-success p-1"
                            [disabled]="!isPdf(f) || (!isPublicFile(f) && countPublicFor(getMatrixRelationId(obligation)) >= 3)"
                            (click)="togglePublic(f, getMatrixRelationId(obligation))" title="{{ isPublicFile(f) ? 'Ocultar del usuario' : 'Mostrar al usuario' }}" style="font-size: 8px;">
                      <i class="fas" [ngClass]="isPublicFile(f) ? 'fa-eye' : 'fa-eye-slash'"></i>
                    </button>
                    <a class="btn btn-sm btn-outline-secondary p-1" [href]="getMatrixFileUrl(f)" target="_blank" title="Ver/Descargar" style="font-size: 8px;"><i class="fas fa-download"></i></a>
                    <button class="btn btn-sm btn-outline-danger p-1" (click)="deleteMatrixFile(f.id, getMatrixRelationId(obligation))" title="Eliminar" style="font-size: 8px;"><i class="fas fa-trash"></i></button>
                  </div>
                </div>

                <div class="small fw-bold mt-2 mb-1">Subidas pendientes</div>
                <div *ngIf="matrixPendingLoading[getMatrixRelationId(obligation)]" class="text-muted small">Cargando pendientes...</div>
                <div *ngIf="!matrixPendingLoading[getMatrixRelationId(obligation)] && (matrixPending[getMatrixRelationId(obligation)]?.length || 0) === 0" class="text-muted small">Sin pendientes.</div>
                <div *ngFor="let p of (matrixPending[getMatrixRelationId(obligation)] || [])" class="d-flex align-items-center justify-content-between py-1">
                  <div class="small">{{ p.originalName || 'Archivo' }} <span class="text-muted">({{ p.requesterUsername || '' }})</span></div>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-danger p-1" (click)="cancelPendingUpload(p.approvalRequestId, getMatrixRelationId(obligation))" title="Cancelar" style="font-size: 8px;"><i class="fas fa-times"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.obligation_matrices?.length === 0" class="text-center py-2">
            <i class="fas fa-balance-scale fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin obligaciones legales</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. Sección Gestionar contratos -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': empresa.type_contracts?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #fa2fe3 0%, #fee140 100%);">
          <div class="d-flex align-items-center justify-content-between h-100">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                  <i class="fas fa-file-contract text-dark" style="font-size: 14px;"></i>
                </div>
              </div>
              <div>
                <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Contratos</h6>
              </div>
            </div>
            <button class="btn btn-success btn-sm" (click)="openAsignContractModal()">
              <i class="fas fa-plus me-1"></i>Agregar
            </button>
          </div>
        </div>
        <div class="card-body p-2">
          
          <div *ngIf="empresa.type_contracts?.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let contract of empresa.type_contracts">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-handshake text-success me-2" style="font-size: 10px;"></i>
                  <span class="small fw-semibold text-dark" style="font-size: 11px;">{{ contract | name:'type_contract' }}</span>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" 
                          title="Editar"
                          (click)="editContract(contract)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          title="Eliminar" 
                          (click)="removeContract(contract.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="empresa.type_contracts?.length === 0" class="text-center py-2">
            <i class="fas fa-file-contract fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin contratos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. Sección Empresas Contratistas -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': hasContractorCompanies() || empresa.contractor_blocks?.length > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-building text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Contratistas</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-primary btn-sm w-100" (click)="openAsignContractorModal()">
              <i class="fas fa-plus me-1"></i>{{ hasContractorCompanies() ? 'Gestionar' : 'Asignar' }}
            </button>
          </div>
          
          <!-- Información de las empresas contratistas asignadas -->
          <div *ngIf="hasContractorCompanies()" class="expanded-content">
            <div class="mb-2" *ngFor="let company of empresa.contractor_companies">
              <div class="d-flex align-items-center justify-content-between p-2 bg-primary bg-opacity-10 rounded mb-1">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-building text-primary me-2" style="font-size: 12px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">
                      {{ getContractorCompanyDisplayName(company) }}
                    </div>
                    <div class="text-muted" style="font-size: 9px;">
                      {{ company?.code || 'Sin código' }}
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" 
                          title="Editar (reemplazar) empresa contratista" 
                          (click)="editContractorCompany(company)"
                          style="font-size: 8px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" 
                          title="Eliminar empresa contratista" 
                          (click)="removeSpecificContractor(company.id)"
                          style="font-size: 8px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Bloques asignados -->
            <div *ngIf="empresa.contractor_blocks?.length > 0" class="mb-1">
              <small class="text-muted fw-semibold" style="font-size: 9px;">BLOQUES ASIGNADOS:</small>
              <div class="mt-1" *ngFor="let block of empresa.contractor_blocks">
                <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                  <div class="d-flex align-items-center flex-grow-1">
                    <i class="fas fa-cube text-info me-2" style="font-size: 8px;"></i>
                    <span class="small fw-semibold text-dark" style="font-size: 10px;">
                      {{ getContractorBlockDisplayName(block) }}
                    </span>
                  </div>
                  <div class="d-flex gap-1">
                    <button class="btn btn-outline-primary btn-sm p-1" 
                            title="Editar bloque" 
                            (click)="editCatalog('empresas-contratistas', block.id)"
                            style="font-size: 7px;">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm p-1" 
                            title="Eliminar bloque" 
                            (click)="removeContractorBlock(block.id)"
                            style="font-size: 7px;">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div *ngIf="empresa.contractor_blocks?.length === 0" class="text-center py-1">
              <small class="text-muted" style="font-size: 9px;">Sin bloques asignados</small>
            </div>
            
            <!-- Botón para eliminar todas las empresas contratistas -->
            <div class="mt-2 text-center">
              <button class="btn btn-outline-danger btn-sm" 
                      title="Eliminar todas las empresas contratistas" 
                      (click)="removeContractor()"
                      style="font-size: 10px;">
                <i class="fas fa-trash me-1"></i>Eliminar todas
              </button>
            </div>
          </div>

          <div *ngIf="!hasContractorCompanies()" class="text-center py-2">
            <i class="fas fa-building fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin empresas contratistas</p>
          </div>

          <!-- Botón explícito para guardar cambios de Contratistas/Bloques -->
          <div class="text-end mt-2">
            <button class="btn btn-primary btn-sm" (click)="saveContractorChanges()">
              <i class="fas fa-save me-1"></i>Guardar cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5a. Sección Administradores de esta empresa -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': businessAdmins.length > 0}">
        <div class="card-header bg-gradient p-2" style="background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);">
          <div class="d-flex align-items-center">
            <div class="me-2">
              <div class="bg-white bg-opacity-20 rounded-circle p-1" style="width: 28px; height: 28px;">
                <i class="fas fa-user-shield text-white" style="font-size: 12px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-white mb-0 fw-bold" style="font-size: 18px;">Administradores</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div *ngIf="isSuperAdmin" class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-warning btn-sm w-100" (click)="openAssignAdminModal()">
              <i class="fas fa-user-plus me-1"></i>Asignar Admin
            </button>
          </div>

          <div *ngIf="businessAdmins.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let admin of businessAdmins">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-user-shield text-warning me-2" style="font-size: 10px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">{{ admin.name || admin.username }}</div>
                    <div class="text-muted" style="font-size: 9px;">{{ admin.email }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="businessAdmins.length === 0" class="text-center py-2">
            <i class="fas fa-user-shield fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin administradores asignados</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 5b. Sección Gestionar usuarios del sistema Empresa -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': users.length > 0}">
        <div class="card-header bg-gradient p-2" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
          <div class="d-flex align-items-center">
            <div class="me-2">
              <div class="bg-white bg-opacity-20 rounded-circle p-1" style="width: 28px; height: 28px;">
                <i class="fas fa-users-cog text-white" style="font-size: 12px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-white mb-0 fw-bold" style="font-size: 18px;">Gestión de Usuarios</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-primary btn-sm w-100" (click)="goToUsersAdmin()">
              <i class="fas fa-users me-1"></i>Usuarios
            </button>
          </div>
          
          <div *ngIf="users.length > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let user of users">
              <div class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-user text-primary me-2" style="font-size: 10px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">{{ user.name }}</div>
                    <div class="text-muted" style="font-size: 9px;">{{ user.email }}</div>
                    <div class="text-muted" style="font-size: 8px;">
                      <span *ngFor="let role of user.roles; let last = last">
                        {{ role }}<span *ngIf="!last">, </span>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" 
                          title="Gestionar"
                          (click)="editUser(user)"
                          style="font-size: 8px;">
                    <i class="fas fa-external-link-alt"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="users.length === 0" class="text-center py-2">
            <i class="fas fa-users-cog fa-lg text-muted opacity-50"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Categorías de Inventario -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': (inventoryCategories.length || 0) > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #8ec5fc 0%, #e0c3fc 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-tags text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Inventario - Categorías</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div *ngIf="invCatError" class="alert alert-danger py-1 small mb-2">{{ invCatError }}</div>
          <div *ngIf="invCatOk" class="alert alert-success py-1 small mb-2">{{ invCatOk }}</div>

          <div class="row g-2 mb-2">
            <div class="col-12">
              <label class="form-label" style="font-size: 11px;">Asignar desde catálogo global</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedGlobalCategoryName" [disabled]="(availableGlobalCategoryCatalog() || []).length === 0">
                <option [ngValue]="null">{{ (availableGlobalCategoryCatalog() || []).length === 0 ? 'No hay categorías disponibles' : 'Seleccione una categoría global' }}</option>
                <option *ngFor="let c of availableGlobalCategoryCatalog()" [ngValue]="c.name">{{ c.name }}</option>
              </select>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-outline-primary btn-sm" (click)="addCategoryFromGlobalCatalog()" [disabled]="invCatLoading || !selectedGlobalCategoryName">
                <i class="fas fa-check"></i> Agregar a esta empresa
              </button>
            </div>
          </div>

          <div *ngIf="(activeInventoryCategories()?.length || 0) > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let c of activeInventoryCategories()">
              <!-- Modo vista normal -->
              <div *ngIf="editingCategoryId !== c.id" class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-tag text-info me-2" style="font-size: 10px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">{{ c.name }}</div>
                    <div class="text-muted" style="font-size: 9px;">{{ c.description || '-' }}</div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" title="Editar" (click)="startEditCategory(c)" style="font-size: 10px; min-width: 26px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" title="Eliminar del listado" (click)="removeFromActiveCategories(c)" style="font-size: 10px; min-width: 26px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <!-- Modo edición inline -->
              <div *ngIf="editingCategoryId === c.id" class="p-2 bg-white border rounded">
                <div class="mb-2">
                  <label class="form-label small mb-1" style="font-size: 10px;">Nombre</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCategoryForm.name" placeholder="Nombre de la categoría" style="font-size: 11px;">
                </div>
                <div class="mb-2">
                  <label class="form-label small mb-1" style="font-size: 10px;">Descripción</label>
                  <textarea class="form-control form-control-sm" [(ngModel)]="editCategoryForm.description" placeholder="Descripción" rows="2" style="font-size: 11px;"></textarea>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-success btn-sm" (click)="saveEditCategory()" [disabled]="invCatLoading" style="font-size: 10px;">
                    <i class="fas fa-check me-1"></i>Guardar
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="cancelEditCategory()" style="font-size: 10px;">
                    <i class="fas fa-times me-1"></i>Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="(activeInventoryCategories()?.length || 0) === 0" class="text-center py-2">
            <i class="fas fa-tags fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin categorías</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Proveedores de Inventario -->
    <div class="col-lg-6 col-xl-3">
      <div class="card shadow-sm border-0 h-100" [ngClass]="{'expanded': (inventorySuppliers.length || 0) > 0}">
        <div class="card-header bg-gradient py-3 px-3" style="background: linear-gradient(90deg, #f6d365 0%, #fda085 100%);">
          <div class="d-flex align-items-center h-100">
            <div class="me-3">
              <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 32px; height: 32px;">
                <i class="fas fa-truck text-dark" style="font-size: 14px;"></i>
              </div>
            </div>
            <div>
              <h6 class="text-dark mb-0 fw-bold" style="font-size: 18px; color: #212529 !important;">Inventario - Proveedores</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div *ngIf="invSupError" class="alert alert-danger py-1 small mb-2">{{ invSupError }}</div>
          <div *ngIf="invSupOk" class="alert alert-success py-1 small mb-2">{{ invSupOk }}</div>

          <div class="row g-2 mb-2">
            <div class="col-12">
              <label class="form-label" style="font-size: 11px;">Asignar desde catálogo global</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedGlobalSupplier" [disabled]="(availableGlobalSupplierCatalog() || []).length === 0">
                <option [ngValue]="null">{{ (availableGlobalSupplierCatalog() || []).length === 0 ? 'No hay proveedores disponibles' : 'Seleccione un proveedor global' }}</option>
                <option *ngFor="let s of availableGlobalSupplierCatalog()" [ngValue]="s">{{ s.name }} {{ s.ruc ? ('(RUC: ' + s.ruc + ')') : '' }}</option>
              </select>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-outline-primary btn-sm" (click)="addSupplierFromGlobalCatalog()" [disabled]="invSupLoading || !selectedGlobalSupplier">
                <i class="fas fa-check"></i> Agregar a esta empresa
              </button>
            </div>
          </div>

          <div *ngIf="(activeInventorySuppliers()?.length || 0) > 0" class="expanded-content">
            <div class="mb-1" *ngFor="let s of activeInventorySuppliers()">
              <!-- Modo vista normal -->
              <div *ngIf="editingSupplierId !== s.id" class="d-flex align-items-center justify-content-between p-1 bg-light rounded">
                <div class="d-flex align-items-center flex-grow-1">
                  <i class="fas fa-truck text-warning me-2" style="font-size: 10px;"></i>
                  <div>
                    <div class="small fw-semibold text-dark" style="font-size: 11px;">{{ s.name }}</div>
                    <div class="text-muted" style="font-size: 9px;">RUC: {{ s.ruc || '-' }} · {{ s.phone || '-' }} · {{ s.email || '-' }}</div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-1">
                  <button class="btn btn-outline-primary btn-sm p-1" title="Editar" (click)="startEditSupplier(s)" style="font-size: 10px; min-width: 26px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm p-1" title="Eliminar del listado" (click)="removeFromActiveSuppliers(s)" style="font-size: 10px; min-width: 26px;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <!-- Modo edición inline -->
              <div *ngIf="editingSupplierId === s.id" class="p-2 bg-white border rounded">
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <label class="form-label small mb-1" style="font-size: 10px;">Nombre</label>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="editSupplierForm.name" placeholder="Nombre del proveedor" style="font-size: 11px;">
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1" style="font-size: 10px;">RUC</label>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="editSupplierForm.ruc" placeholder="RUC" style="font-size: 11px;">
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1" style="font-size: 10px;">Teléfono</label>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="editSupplierForm.phone" placeholder="Teléfono" style="font-size: 11px;">
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1" style="font-size: 10px;">Email</label>
                    <input type="email" class="form-control form-control-sm" [(ngModel)]="editSupplierForm.email" placeholder="Email" style="font-size: 11px;">
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1" style="font-size: 10px;">Dirección</label>
                    <textarea class="form-control form-control-sm" [(ngModel)]="editSupplierForm.address" placeholder="Dirección" rows="2" style="font-size: 11px;"></textarea>
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-success btn-sm" (click)="saveEditSupplier()" [disabled]="invSupLoading" style="font-size: 10px;">
                    <i class="fas fa-check me-1"></i>Guardar
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="cancelEditSupplier()" style="font-size: 10px;">
                    <i class="fas fa-times me-1"></i>Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="(activeInventorySuppliers()?.length || 0) === 0" class="text-center py-2">
            <i class="fas fa-truck fa-lg text-muted opacity-50"></i>
            <p class="text-muted small mb-0" style="font-size: 10px;">Sin proveedores</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección Configuración Matriz Legal (admin) -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card shadow border-0 h-100">
        <div class="card-header bg-gradient" style="background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 40px; height: 40px;">
                  <i class="fas fa-bell text-white"></i>
                </div>
              </div>
              <div>
                <h5 class="text-white mb-0 fw-bold">Configuración matriz legal</h5>
                <small class="text-white-50">Empresa #{{ empresaId }}</small>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <a class="btn btn-outline-light btn-sm" [routerLink]="['/dashboard','admin','empresas','configuracion-matriz', empresaId]">
                <i class="fas fa-cog me-1"></i> Abrir en pantalla completa
              </a>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <app-matrix-config [businessId]="empresaId"></app-matrix-config>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección Personal (al final como solicitaste) -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card shadow border-0 h-100">
        <div class="card-header bg-gradient" style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <div class="bg-white bg-opacity-20 rounded-circle p-2" style="width: 40px; height: 40px;">
                  <i class="fas fa-users text-white"></i>
                </div>
              </div>
              <div>
                <h5 class="text-white mb-0 fw-bold">Gestionar personal de la empresa</h5>
                <small class="text-white-50">{{ empresa.employees?.length || 0 }} empleados</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted mb-0">
              <i class="fas fa-users me-2"></i>Gestionar personal de la empresa
            </h6>
            <div class="d-flex align-items-center gap-2">
              <div class="input-group input-group-sm" style="width: 280px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Buscar por nombre o cédula" [(ngModel)]="employeesFilter">
              </div>
              <button class="btn btn-sm btn-outline-secondary" (click)="loadCompanyEmployees()" [disabled]="employeesLoading">
                <i class="fas" [ngClass]="employeesLoading ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                {{ employeesLoading ? 'Cargando...' : 'Recargar' }}
              </button>
              <button class="btn btn-sm btn-outline-primary" (click)="goToTHEmployees()">
                <i class="fas fa-external-link-alt me-1"></i>
                Ir a Talento Humano
              </button>
            </div>
          </div>

          <div class="px-3 py-2 border-bottom bg-light small text-muted" *ngIf="!employeesLoading">
            Mostrando {{ filteredCompanyEmployees().length }} empleado{{ filteredCompanyEmployees().length === 1 ? '' : 's' }}
          </div>

          <div *ngIf="employeesLoading" class="text-center py-5">Cargando personal...</div>
          <div *ngIf="!employeesLoading && filteredCompanyEmployees().length === 0" class="text-center py-5 text-muted">
            <i class="fas fa-users fa-2x mb-2"></i>
            <div>No hay personal registrado</div>
          </div>
          <div *ngIf="!employeesLoading && filteredCompanyEmployees().length > 0" class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 60px;">Foto</th>
                  <th>Nombre</th>
                  <th style="width: 180px;">Cédula</th>
                  <th style="width: 200px;">Código del trabajador</th>
                  <th style="width: 240px;">Departamento</th>
                  <th style="width: 280px;">Cargo</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let e of filteredCompanyEmployees()">
                  <td>
                    <img [src]="getEmployeePhotoUrlAdmin(e)" alt="Foto" class="rounded-circle" style="width:40px;height:40px;object-fit:cover;" (error)="onImgError($event)"/>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ (e.nombres || e.name) + ' ' + (e.apellidos || '') }}</div>
                    <div class="text-muted small">{{ e.businessName || '' }}</div>
                  </td>
                  <td>{{ e.cedula }}</td>
                  <td>
                    <div *ngIf="editingEmployeeCodeId !== e.id; else editCodeTpl">
                      <span>{{ getEmployeeCodeAdmin(e) || '—' }}</span>
                      <button class="btn btn-sm btn-outline-primary ms-2" (click)="startEditEmployeeCode(e)" title="Editar código">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                    <ng-template #editCodeTpl>
                      <div class="input-group input-group-sm" style="max-width: 260px;">
                        <input type="text" class="form-control" [(ngModel)]="editEmployeeCodeValue" [disabled]="savingEmployeeCode" placeholder="Código del trabajador">
                        <button class="btn btn-success" (click)="saveEmployeeCode(e)" [disabled]="savingEmployeeCode">
                          <i class="fas" [ngClass]="savingEmployeeCode ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                        </button>
                        <button class="btn btn-outline-secondary" (click)="cancelEditEmployeeCode()" [disabled]="savingEmployeeCode">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </ng-template>
                  </td>
                  <td>{{ getDepartmentNameByEmployee(e) }}</td>
                  <td>{{ getPositionNameByEmployee(e) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Modal para editar empresa -->
      <div *ngIf="showEditEmpresaModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
              <div class="d-flex align-items-center">
                <i class="fas fa-edit me-2"></i>
                <h5 class="modal-title mb-0">Editar Información de Empresa</h5>
              </div>
              <button type="button" class="btn-close btn-close-white" (click)="closeEditEmpresaModal()"></button>
            </div>
            <div class="modal-body p-4">
              <form>
                <div class="row">
                  <!-- Nombre de la empresa -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaName" class="form-label fw-semibold">
                      <i class="fas fa-building me-2 text-primary"></i>Razón Social *
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="empresaName"
                      [(ngModel)]="editEmpresa.name"
                      name="name"
                      required
                      placeholder="Ingrese la razón social">
                  </div>
      
                  <!-- RUC -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaRuc" class="form-label fw-semibold">
                      <i class="fas fa-id-card me-2 text-primary"></i>RUC *
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="empresaRuc"
                      [(ngModel)]="editEmpresa.ruc"
                      name="ruc"
                      required
                      placeholder="Ingrese el RUC">
                  </div>
                </div>
      
                <div class="row">
                  <!-- Tipo de empresa -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaBusinessType" class="form-label fw-semibold">
                      <i class="fas fa-industry me-2 text-primary"></i>Tipo de Empresa
                    </label>
                    <select
                      class="form-select"
                      id="empresaBusinessType"
                      [(ngModel)]="editEmpresa.businessType"
                      name="businessType">
                      <option value="">Seleccionar tipo</option>
                      <option value="PRIVADA">Privada</option>
                      <option value="PUBLICA">Pública</option>
                      <option value="MIXTA">Mixta</option>
                    </select>
                  </div>

                  <!-- Estado (activo) -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                      <i class="fas fa-toggle-on me-2 text-primary"></i>Estado
                    </label>
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" id="empresaActive"
                             [(ngModel)]="editEmpresa.active" name="active">
                      <label class="form-check-label" for="empresaActive">{{ editEmpresa.active ? 'Activo' : 'Inactivo' }}</label>
                    </div>
                  </div>
                </div>
      
                <!-- Representante legal -->
                <div class="mb-3">
                  <label for="empresaRepresentative" class="form-label fw-semibold">
                    <i class="fas fa-user-tie me-2 text-primary"></i>Representante Legal
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="empresaRepresentative"
                    [(ngModel)]="editEmpresa.representative_legal"
                    name="representative_legal"
                    placeholder="Ingrese el nombre del representante legal">
                </div>
      
                <div class="row">
                  <!-- Email -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaEmail" class="form-label fw-semibold">
                      <i class="fas fa-envelope me-2 text-primary"></i>Email
                    </label>
                    <input
                      type="email"
                      class="form-control"
                      id="empresaEmail"
                      [(ngModel)]="editEmpresa.email"
                      name="email"
                      placeholder="empresa@ejemplo.com">
                  </div>
      
                  <!-- Teléfono -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaPhone" class="form-label fw-semibold">
                      <i class="fas fa-phone me-2 text-primary"></i>Teléfono
                    </label>
                    <input
                      type="tel"
                      class="form-control"
                      id="empresaPhone"
                      [(ngModel)]="editEmpresa.phone"
                      name="phone"
                      placeholder="Ingrese el teléfono">
                  </div>
                </div>

                <div class="row">
                  <!-- Teléfono Secundario -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaSecondaryPhone" class="form-label fw-semibold">
                      <i class="fas fa-phone-volume me-2 text-primary"></i>Teléfono secundario
                    </label>
                    <input
                      type="tel"
                      class="form-control"
                      id="empresaSecondaryPhone"
                      [(ngModel)]="editEmpresa.secondaryPhone"
                      name="secondaryPhone"
                      placeholder="Opcional">
                  </div>

                  <!-- Sitio web -->
                  <div class="col-md-6 mb-3">
                    <label for="empresaWebsite" class="form-label fw-semibold">
                      <i class="fas fa-globe me-2 text-primary"></i>Sitio web
                    </label>
                    <input
                      type="url"
                      class="form-control"
                      id="empresaWebsite"
                      [(ngModel)]="editEmpresa.website"
                      name="website"
                      placeholder="https://ejemplo.com">
                  </div>
                </div>
      
                <!-- Dirección -->
                <div class="mb-3">
                  <label for="empresaAddress" class="form-label fw-semibold">
                    <i class="fas fa-map-marker-alt me-2 text-primary"></i>Dirección
                  </label>
                  <textarea
                    class="form-control"
                    id="empresaAddress"
                    [(ngModel)]="editEmpresa.address"
                    name="address"
                    rows="3"
                    placeholder="Ingrese la dirección completa"></textarea>
                </div>

                <!-- Nombre corto y comercial -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="empresaNameShort" class="form-label fw-semibold">
                      <i class="fas fa-tag me-2 text-primary"></i>Nombre corto
                    </label>
                    <input type="text" class="form-control" id="empresaNameShort"
                           [(ngModel)]="editEmpresa.nameShort" name="nameShort" placeholder="Opcional">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="empresaTradeName" class="form-label fw-semibold">
                      <i class="fas fa-briefcase me-2 text-primary"></i>Nombre comercial
                    </label>
                    <input type="text" class="form-control" id="empresaTradeName"
                           [(ngModel)]="editEmpresa.tradeName" name="tradeName" placeholder="Opcional">
                  </div>
                </div>

                <!-- Actividad comercial y descripción -->
                <div class="mb-3">
                  <label for="empresaCommercialActivity" class="form-label fw-semibold">
                    <i class="fas fa-industry me-2 text-primary"></i>Actividad comercial
                  </label>
                  <input type="text" class="form-control" id="empresaCommercialActivity"
                         [(ngModel)]="editEmpresa.commercialActivity" name="commercialActivity" placeholder="Opcional">
                </div>

                <div class="mb-3">
                  <label for="empresaDescription" class="form-label fw-semibold">
                    <i class="fas fa-align-left me-2 text-primary"></i>Descripción
                  </label>
                  <textarea class="form-control" id="empresaDescription" rows="3"
                            [(ngModel)]="editEmpresa.description" name="description" placeholder="Opcional"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button type="button" class="btn btn-outline-secondary" (click)="closeEditEmpresaModal()" [disabled]="savingEmpresa">
                <i class="fas fa-times me-1"></i>Cancelar
              </button>
              <button type="button" class="btn btn-primary" (click)="saveEmpresaEdit()" [disabled]="savingEmpresa || !editEmpresa.name || !editEmpresa.ruc">
                <i class="fas" [ngClass]="savingEmpresa ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                <span class="ms-1">{{ savingEmpresa ? 'Guardando...' : 'Guardar Cambios' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<!-- Estados de carga y error mejorados -->
<div *ngIf="loading" class="d-flex justify-content-center align-items-center vh-100">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h5 class="text-muted">Cargando detalles de la empresa</h5>
    <p class="text-muted">Por favor espera un momento...</p>
  </div>
</div>

<div *ngIf="error" class="alert alert-danger alert-dismissible fade show shadow" role="alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
    <div>
      <h6 class="alert-heading mb-1">Error al cargar datos</h6>
      <p class="mb-0">{{ error }}</p>
    </div>
  </div>
  <button type="button" class="btn-close" (click)="error = null"></button>
</div>

<!-- Modales con diseño profesional -->
<!-- Modal para crear/editar usuario -->
<div *ngIf="showUserModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-user-plus me-2"></i>
          <h5 class="modal-title mb-0">
            {{ userToEdit ? 'Editar Usuario' : 'Crear Usuario' }}
          </h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showUserModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center py-4">
          <i class="fas fa-tools fa-3x text-muted mb-3"></i>
          <h6 class="text-muted">Funcionalidad en desarrollo</h6>
          <p class="text-muted small">El formulario de usuario estará disponible próximamente</p>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showUserModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="showUserModal = false" disabled>
          <i class="fas fa-save me-1"></i>Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar obligación (relación de empresa) - ubicado al final para evitar flicker -->
<div *ngIf="showEditObligationModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-edit me-2"></i>
          <h5 class="modal-title mb-0">Editar Matriz Legal</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="closeEditObligationModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3">
          <label class="form-label fw-semibold">Nombre</label>
          <input type="text" class="form-control" [(ngModel)]="editObligation.name" [ngModelOptions]="{updateOn: 'blur'}" placeholder="Nombre" />
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Descripción</label>
          <textarea class="form-control" [(ngModel)]="editObligation.description" [ngModelOptions]="{updateOn: 'blur'}" rows="3" placeholder="Descripción"></textarea>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Fecha de vencimiento</label>
            <input type="date" class="form-control" [(ngModel)]="editObligation.dueDate" [ngModelOptions]="{updateOn: 'blur'}" />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Estado</label>
            <select class="form-select" [(ngModel)]="editObligation.status" [ngModelOptions]="{updateOn: 'blur'}">
              <option [ngValue]="null">—</option>
              <option value="PENDING">PENDIENTE</option>
              <option value="IN_PROGRESS">EN PROCESO</option>
              <option value="COMPLETED">COMPLETADO</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Prioridad</label>
            <select class="form-select" [(ngModel)]="editObligation.priority" [ngModelOptions]="{updateOn: 'blur'}">
              <option [ngValue]="null">—</option>
              <option value="LOW">BAJA</option>
              <option value="MEDIUM">MEDIA</option>
              <option value="HIGH">ALTA</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Responsable</label>
            <input type="text" class="form-control" [(ngModel)]="editObligation.responsiblePerson" [ngModelOptions]="{updateOn: 'blur'}" placeholder="Responsable" />
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="closeEditObligationModal()" [disabled]="savingObligation">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveObligationEdit()" [disabled]="savingObligation">
          <i class="fas" [ngClass]="savingObligation ? 'fa-spinner fa-spin' : 'fa-save'"></i>
          <span class="ms-1">Guardar</span>
        </button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal para asignar departamento -->
<div *ngIf="showAsignDepartmentModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-building me-2"></i>
          <h5 class="modal-title mb-0">Asignar Departamento</h5>
        </div>
        <button type="button" class="btn-close" (click)="closeAsignDepartmentModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectDepartamento" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Departamentos
          </label>
          <select class="form-select form-select-lg" id="selectDepartamento" [(ngModel)]="selectedDepartamentos" multiple size="6">
            <option *ngFor="let dept of getAvailableDepartamentos()" [ngValue]="dept.id">
              <i class="fas fa-building"></i> {{ dept.name }}
            </option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples departamentos
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="closeAsignDepartmentModal()">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="asignDepartment()" [disabled]="!selectedDepartamentos.length">
          <i class="fas fa-plus me-1"></i>Asignar Departamentos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar cargo -->
<div *ngIf="showAsignCargoModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-briefcase me-2"></i>
          <h5 class="modal-title mb-0">Asignar Cargo</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignCargoModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectCargo" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Cargos
          </label>
          <select class="form-select form-select-lg" id="selectCargo" [(ngModel)]="selectedCargos" multiple size="6">
            <option *ngFor="let cargo of getAvailableCargos()" [ngValue]="cargo.id">{{ cargo.name }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples cargos
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignCargoModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-info" (click)="asignCargo()" [disabled]="!selectedCargos.length">
          <i class="fas fa-plus me-1"></i>Asignar Cargos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar tipo de documento -->
<div *ngIf="showAsignDocumentModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-file-alt me-2"></i>
          <h5 class="modal-title mb-0">Asignar Tipo de Documento</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignDocumentModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectTipoDocumento" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Tipos de Documentos
          </label>
          <select class="form-select form-select-lg" id="selectTipoDocumento" [(ngModel)]="selectedTiposDocumentos" multiple size="6">
            <option *ngFor="let tipo of getAvailableTiposDocumentos()" [ngValue]="tipo.id">{{ tipo.name }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples tipos de documentos
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignDocumentModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="asignDocument()" [disabled]="!selectedTiposDocumentos.length">
          <i class="fas fa-plus me-1"></i>Asignar Documentos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar tipo de contrato -->
<div *ngIf="showAsignContractModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-secondary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-file-signature me-2"></i>
          <h5 class="modal-title mb-0">Asignar Tipo de Contrato</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignContractModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectTipoContrato" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Tipos de Contratos
          </label>
          <select class="form-select form-select-lg" id="selectTipoContrato" [(ngModel)]="selectedTiposContratos" multiple size="6">
            <option *ngFor="let tipo of getAvailableTiposContratos()" [ngValue]="tipo.id">{{ tipo.name }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples tipos de contratos
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignContractModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-secondary" (click)="asignContract()" [disabled]="!selectedTiposContratos.length">
          <i class="fas fa-plus me-1"></i>Asignar Tipos de Contratos
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal para asignar cursos y certificaciones -->
<div *ngIf="showAsignCourseCertModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-certificate me-2"></i>
          <h5 class="modal-title mb-0">Asignar Cursos y certificaciones</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignCourseCertModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectCourseCert" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Cursos/Certificaciones
          </label>
          <select class="form-select form-select-lg" id="selectCourseCert" [(ngModel)]="selectedCourseCertifications" multiple size="6">
            <option *ngFor="let cc of getAvailableCourseCertifications()" [ngValue]="cc.id">{{ cc.name || cc.title || cc.description }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples items
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignCourseCertModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success" (click)="asignCourseCert()" [disabled]="!selectedCourseCertifications.length">
          <i class="fas fa-plus me-1"></i>Asignar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar tarjetas -->
<div *ngIf="showAsignCardModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-id-badge me-2"></i>
          <h5 class="modal-title mb-0">Asignar Tarjetas</h5>
        </div>
        <button type="button" class="btn-close" (click)="showAsignCardModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectCards" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Tarjetas
          </label>
          <select class="form-select form-select-lg" id="selectCards" [(ngModel)]="selectedCards" multiple size="6">
            <option *ngFor="let c of getAvailableCards()" [ngValue]="c.id">{{ c.name || c.title || c.description }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples tarjetas
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignCardModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="asignCard()" [disabled]="!selectedCards.length">
          <i class="fas fa-plus me-1"></i>Asignar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar IESS -->
<div *ngIf="showAsignIessModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-shield-alt me-2"></i>
          <h5 class="modal-title mb-0">Asignar IESS</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignIessModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectIess" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar IESS
          </label>
          <select class="form-select form-select-lg" id="selectIess" [(ngModel)]="selectedIess" multiple size="6">
            <option *ngFor="let i of getAvailableIess()" [ngValue]="i">{{ getIessDisplayName(i) }}</option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples items
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignIessModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="asignIess()" [disabled]="!selectedIess.length">
          <i class="fas fa-plus me-1"></i>Asignar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar obligación -->
<div *ngIf="showAsignObligationModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-clipboard-list me-2"></i>
          <h5 class="modal-title mb-0">Asignar Obligación</h5>
        </div>
        <button type="button" class="btn-close" (click)="showAsignObligationModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-4">
          <label for="selectObligacion" class="form-label fw-semibold">
            <i class="fas fa-list me-2"></i>Seleccionar Obligaciones
          </label>
          <select class="form-select form-select-lg" id="selectObligacion" [(ngModel)]="selectedObligacionesMatriz" multiple size="6">
            <option *ngFor="let obligacion of getAvailableObligacionesMatriz(); trackBy: trackById" [ngValue]="obligacion.id">
              {{ formatObligationLabel(obligacion) }}
            </option>
          </select>
          <div *ngIf="obligacionesMatriz.length === 0" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No hay matrices de obligaciones disponibles. Verifique la configuración del sistema.
          </div>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples obligaciones
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignObligationModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="asignObligation()" [disabled]="!selectedObligacionesMatriz.length">
          <i class="fas fa-plus me-1"></i>Asignar Obligaciones
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Eliminado modal duplicado de IESS -->

<!-- Modal Crear Usuario -->
<div *ngIf="showCreateUserModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content shadow-lg border-0 rounded-3">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-user-plus me-2"></i>{{ isEditingUser ? 'Editar Usuario' : 'Crear Usuario para Empresa' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeUserModal()"></button>
      </div>
      <div class="modal-body">
        <form #userForm="ngForm">
          <div class="row">
            <!-- Nombre -->
            <div class="col-md-6 mb-3">
              <label for="nombres" class="form-label fw-semibold">
                <i class="fas fa-user me-2 text-primary"></i>Nombres *
              </label>
              <input 
                type="text" 
                class="form-control" 
                id="nombres"
                name="nombres"
                [(ngModel)]="newUser.nombres"
                required
                placeholder="Ingrese los nombres">
            </div>
            
            <!-- Apellidos -->
            <div class="col-md-6 mb-3">
              <label for="apellidos" class="form-label fw-semibold">
                <i class="fas fa-user me-2 text-primary"></i>Apellidos *
              </label>
              <input 
                type="text" 
                class="form-control" 
                id="apellidos"
                name="apellidos"
                [(ngModel)]="newUser.apellidos"
                required
                placeholder="Ingrese los apellidos">
            </div>
          </div>
          
          <div class="row">
            <!-- Cédula -->
            <div class="col-md-6 mb-3">
              <label for="cedula" class="form-label fw-semibold">
                <i class="fas fa-id-card me-2 text-primary"></i>Cédula *
              </label>
              <input 
                type="text" 
                class="form-control" 
                id="cedula"
                name="cedula"
                [(ngModel)]="newUser.cedula"
                required
                placeholder="Ingrese la cédula"
                maxlength="10">
            </div>
            
            <!-- Teléfono -->
            <div class="col-md-6 mb-3">
              <label for="telefono" class="form-label fw-semibold">
                <i class="fas fa-phone me-2 text-primary"></i>Número de Teléfono *
              </label>
              <input 
                type="tel" 
                class="form-control" 
                id="telefono"
                name="telefono"
                [(ngModel)]="newUser.telefono"
                required
                placeholder="Ingrese el teléfono">
            </div>
          </div>
          
          <!-- Correo Electrónico -->
          <div class="mb-3">
            <label for="email" class="form-label fw-semibold">
              <i class="fas fa-envelope me-2 text-primary"></i>Correo Electrónico *
            </label>
            <input 
              type="email" 
              class="form-control" 
              id="email"
              name="email"
              [(ngModel)]="newUser.email"
              required
              placeholder="usuario@ejemplo.com">
          </div>
          
          <div class="row">
            <!-- Usuario -->
            <div class="col-md-6 mb-3">
              <label for="username" class="form-label fw-semibold">
                <i class="fas fa-user-circle me-2 text-primary"></i>Usuario *
              </label>
              <input 
                type="text" 
                class="form-control" 
                id="username"
                name="username"
                [(ngModel)]="newUser.username"
                required
                placeholder="Nombre de usuario">
            </div>
            
            <!-- Contraseña -->
            <div class="col-md-6 mb-3">
              <label for="password" class="form-label fw-semibold">
                <i class="fas fa-lock me-2 text-primary"></i>Contraseña *
              </label>
              <div class="input-group">
                <input 
                  [type]="showPassword ? 'text' : 'password'" 
                  class="form-control" 
                  id="password"
                  name="password"
                  [(ngModel)]="newUser.password"
                  required
                  placeholder="Contraseña segura">
                <button 
                  type="button" 
                  class="btn btn-outline-secondary" 
                  (click)="showPassword = !showPassword">
                  <i class="fas" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Selección de Roles -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-user-shield me-2 text-primary"></i>Roles (Opcional)
            </label>
            <div class="row">
              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="form-text mb-2">
                    <small><i class="fas fa-info-circle me-1"></i>Si no selecciona ningún rol, se asignará el rol por defecto "ROLE_USER"</small>
                  </div>
                  <div class="row" *ngIf="roles.length > 0">
                    <div class="col-md-6" *ngFor="let role of roles">
                      <div class="form-check">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'role-' + role.id"
                          [value]="role.id"
                          [checked]="newUser.selectedRoles.includes(role.id)"
                          (change)="onRoleChange(role.id, $event)">
                        <label class="form-check-label" [for]="'role-' + role.id">
                          <strong>{{ role.name }}</strong>
                          <div class="text-muted small" *ngIf="role.description">
                            {{ role.description }}
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="roles.length === 0" class="text-muted">
                    <i class="fas fa-spinner fa-spin me-2"></i>Cargando roles...
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info">
            <small>
              <i class="fas fa-info-circle me-2"></i>
              Este usuario tendrá acceso a la empresa <strong>{{ empresa.name }}</strong>
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <!-- Botón temporal para depurar -->
        <button type="button" class="btn btn-info btn-sm" (click)="debugFormValidation(userForm)">
          <i class="fas fa-bug me-1"></i>Debug Form
        </button>
        
        <button type="button" class="btn btn-outline-secondary" (click)="closeUserModal()">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="createUser()" 
          [disabled]="!isFormValid()">
          <i class="fas fa-save me-1"></i>{{ isEditingUser ? 'Actualizar Usuario' : 'Crear Usuario' }}
        </button>
        
        <!-- Información de estado del formulario -->
        <small class="text-muted d-block mt-2">
          Form Valid: {{ userForm.form.valid }} | 
          Required fields: nombres, apellidos, email, username, password
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Modal para asignar empresas contratistas -->
<div *ngIf="showAsignContractorModal" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient text-white border-0" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
        <div class="d-flex align-items-center">
          <i class="fas fa-building me-2"></i>
          <h5 class="modal-title mb-0">Gestionar Empresas Contratistas</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="showAsignContractorModal = false"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Empresas contratistas actualmente asignadas -->
        <div *ngIf="hasContractorCompanies()" class="mb-4">
          <h6 class="text-primary fw-semibold">
            <i class="fas fa-building me-2"></i>Empresas Contratistas Asignadas:
          </h6>
          <div class="row g-2">
            <div class="col-md-6" *ngFor="let company of empresa.contractor_companies">
              <div class="card bg-light border-primary">
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong class="small">{{ company.name }}</strong><br>
                      <small class="text-muted">{{ company.code || 'Sin código' }}</small>
                    </div>
                    <div class="btn-group">
                      <button class="btn btn-outline-primary btn-sm" 
                              (click)="editContractorCompany(company)"
                              title="Reemplazar">
                        <i class="fas fa-exchange-alt"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" 
                              (click)="removeSpecificContractor(company.id)"
                              title="Eliminar empresa">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selección de nuevas empresas contratistas -->
        <div class="mb-4">
          <label for="selectContractorCompanies" class="form-label fw-semibold">
            <i class="fas fa-plus me-2 text-success"></i>Agregar Empresas Contratistas
          </label>
          <select class="form-select form-select-lg" 
                  id="selectContractorCompanies" 
                  [(ngModel)]="selectedContractorCompanies" 
                  multiple size="5"
                  (change)="onContractorCompanyChange()">
            <option *ngFor="let company of getAvailableContractorCompanies()" [ngValue]="company">
              {{ company.name }} ({{ company.code || 'Sin código' }})
            </option>
          </select>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples empresas contratistas
          </div>
          <div *ngIf="getAvailableContractorCompanies().length === 0" class="alert alert-info mt-2">
            <i class="fas fa-info-circle me-2"></i>
            Todas las empresas contratistas disponibles ya están asignadas.
          </div>
        </div>

        <!-- Información de las empresas contratistas seleccionadas -->
        <div *ngIf="selectedContractorCompanies.length > 0" class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Empresas Seleccionadas para Agregar:</h6>
          <ul class="mb-0">
            <li *ngFor="let company of selectedContractorCompanies">
              <strong>{{ company.name }}</strong>
              <span *ngIf="company.code"> ({{ company.code }})</span>
              <span *ngIf="company.description"> - {{ company.description }}</span>
            </li>
          </ul>
        </div>

        <!-- Selección de bloques (opcional) -->
        <div *ngIf="selectedContractorCompanies.length > 0" class="mb-4">
          <label for="selectBlocks" class="form-label fw-semibold">
            <i class="fas fa-cubes me-2 text-info"></i>Seleccionar Bloques (Opcional)
          </label>
          
          <div *ngIf="availableBlocks.length > 0">
            <select class="form-select form-select-lg" 
                    id="selectBlocks" 
                    [(ngModel)]="selectedBlocks" 
                    multiple size="6">
              <option *ngFor="let block of availableBlocks" [ngValue]="block">
                {{ block.name }} - {{ block.code || 'Sin código' }}
                <span *ngIf="block.description"> ({{ block.description }})</span>
              </option>
            </select>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Mantén presionado Ctrl (o Cmd en Mac) para seleccionar múltiples bloques
            </div>
          </div>
          
          <div *ngIf="availableBlocks.length === 0" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Las empresas contratistas seleccionadas no tienen bloques disponibles.
          </div>
        </div>

        <!-- Información sobre bloques seleccionados -->
        <div *ngIf="selectedBlocks.length > 0" class="alert alert-success">
          <h6><i class="fas fa-check-circle me-2"></i>Bloques Seleccionados:</h6>
          <ul class="mb-0">
            <li *ngFor="let block of selectedBlocks">
              <strong>{{ block.name }}</strong>
              <span *ngIf="block.code"> ({{ block.code }})</span>
              <span *ngIf="block.description"> - {{ block.description }}</span>
            </li>
          </ul>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="showAsignContractorModal = false">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="asignContractor()" 
                [disabled]="selectedContractorCompanies.length === 0">
          <i class="fas fa-save me-1"></i>Agregar Empresas Contratistas
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Asignar Administrador a esta empresa -->
<div class="modal-backdrop fade show" *ngIf="showAssignAdminModal" (click)="closeAssignAdminModal()"></div>
<div class="modal d-block fade show" tabindex="-1" *ngIf="showAssignAdminModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
          <i class="fas fa-user-shield me-2"></i>Asignar Administrador
        </h5>
        <button type="button" class="btn-close" (click)="closeAssignAdminModal()"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">
          Seleccione un usuario del sistema para promoverlo como administrador de <strong>{{ empresa?.name }}</strong>.
          El usuario recibirá el rol ADMIN y acceso exclusivo a esta empresa.
        </p>
        <div class="mb-3">
          <label class="form-label fw-semibold">Usuario:</label>
          <select class="form-select" [(ngModel)]="selectedUserIdForAdmin">
            <option [ngValue]="null" disabled>-- Seleccione un usuario --</option>
            <option *ngFor="let u of allSystemUsers" [ngValue]="u.id">
              {{ u.name || u.username }} - {{ u.email }}
            </option>
          </select>
        </div>
        <div *ngIf="allSystemUsers.length === 0" class="alert alert-info small py-2">
          <i class="fas fa-info-circle me-1"></i>No hay usuarios disponibles para asignar.
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="closeAssignAdminModal()">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-warning" 
                (click)="confirmAssignAdmin()" 
                [disabled]="!selectedUserIdForAdmin">
          <i class="fas fa-user-shield me-1"></i>Asignar como Admin
        </button>
      </div>
    </div>
  </div>
</div>
