<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso de emergencia - Improvement Solutions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        h2 {
            margin-top: 30px;
            color: #343a40;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }
        
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .list-group {
            display: flex;
            flex-direction: column;
            padding-left: 0;
            margin-bottom: 20px;
            border-radius: .25rem;
        }
        
        .list-group-item {
            position: relative;
            display: block;
            padding: 12px 20px;
            margin-bottom: -1px;
            background-color: #fff;
            border: 1px solid rgba(0,0,0,0.125);
        }
        
        .list-group-item:first-child {
            border-top-left-radius: .25rem;
            border-top-right-radius: .25rem;
        }
        
        .list-group-item:last-child {
            border-bottom-left-radius: .25rem;
            border-bottom-right-radius: .25rem;
            margin-bottom: 0;
        }
        
        code {
            font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            padding: 2px 4px;
            font-size: 90%;
            color: #e83e8c;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #eaeaea;
        }
        
        .btn {
            display: inline-block;
            font-weight: 400;
            text-align: center;
            vertical-align: middle;
            padding: 8px 12px;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: .25rem;
            transition: all .15s ease-in-out;
            text-decoration: none;
            cursor: pointer;
            user-select: none;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            color: #fff;
            background-color: #007bff;
            border: 1px solid #007bff;
        }
        
        .btn-danger {
            color: #fff;
            background-color: #dc3545;
            border: 1px solid #dc3545;
        }
        
        .btn-info {
            color: #fff;
            background-color: #17a2b8;
            border: 1px solid #17a2b8;
        }
        
        .btn:hover {
            opacity: 0.85;
        }
        
        #loginForm {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 8px 12px;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            box-sizing: border-box;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Acceso de emergencia - Improvement Solutions</h1>
        
        <div class="alert alert-warning">
            <strong>¡Atención!</strong> Esta página está diseñada para resolver problemas de autenticación en situaciones de emergencia. 
            No use este acceso para operaciones normales.
        </div>
        
        <h2>1. Login de emergencia</h2>
        <p>Utilice este formulario para iniciar sesión de forma directa, evitando los problemas de CORS e interceptores:</p>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" class="form-control" value="javier" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" class="form-control" value="12345" required>
            </div>
            <button type="submit" class="btn btn-primary" id="loginButton">Iniciar sesión</button>
            <button type="button" class="btn btn-info" id="diagnosisButton">Ejecutar diagnóstico</button>
        </form>
        
        <div id="loginResult" class="results" style="display:none;"></div>
        
        <h2>2. Diagnóstico de problema</h2>
        <p>Verifique la conectividad y configuración del servidor:</p>
        
        <div class="list-group">
            <div class="list-group-item">
                <h3>Verificar estado del servidor</h3>
                <button class="btn btn-info" id="checkServer">Verificar servidor</button>
                <div id="serverStatus" class="results" style="display:none;"></div>
            </div>
            
            <div class="list-group-item">
                <h3>Verificar configuración CORS</h3>
                <button class="btn btn-info" id="checkCors">Verificar CORS</button>
                <div id="corsStatus" class="results" style="display:none;"></div>
            </div>
            
            <div class="list-group-item">
                <h3>Verificar autenticación actual</h3>
                <button class="btn btn-info" id="checkAuth">Verificar autenticación</button>
                <div id="authStatus" class="results" style="display:none;"></div>
            </div>
        </div>
        
        <h2>3. Soluciones</h2>
        <p>Opciones para resolver los problemas más comunes:</p>
        
        <button class="btn btn-danger" id="clearLocalStorage">Limpiar localStorage</button>
        <button class="btn btn-danger" id="clearCookies">Limpiar cookies</button>
        <a href="http://localhost:4200/features/auth/auth-bypass" class="btn btn-primary">Ir a módulo de bypass Auth</a>
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const baseUrl = 'http://localhost:8080/api/v1';
            
            // Login de emergencia
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const resultDiv = document.getElementById('loginResult');
                
                resultDiv.style.display = 'block';
                resultDiv.textContent = 'Iniciando sesión...';
                
                fetch(`${baseUrl}/public/diagnostic/auth-bypass`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resultDiv.innerHTML = '<strong>¡Login exitoso!</strong><br>';
                    resultDiv.innerHTML += `Token: ${data.token ? data.token.substring(0, 20) + '...' : 'No recibido'}<br>`;
                    
                    // Guardar el token en localStorage
                    if (data.token) {
                        localStorage.setItem('auth_token', data.token);
                        resultDiv.innerHTML += 'Token guardado en localStorage.<br>';
                    }
                    
                    // Guardar información de usuario
                    if (data.userDetail) {
                        localStorage.setItem('current_user', JSON.stringify(data.userDetail));
                        resultDiv.innerHTML += 'Información de usuario guardada.<br>';
                        resultDiv.innerHTML += `Usuario: ${data.userDetail.username}<br>`;
                        resultDiv.innerHTML += `Nombre: ${data.userDetail.name}<br>`;
                        resultDiv.innerHTML += `Email: ${data.userDetail.email}<br>`;
                        resultDiv.innerHTML += `Roles: ${data.userDetail.roles.join(', ')}<br>`;
                    }
                    
                    resultDiv.innerHTML += '<br><a href="http://localhost:4200/dashboard" class="btn btn-primary">Ir al Dashboard</a>';
                })
                .catch(error => {
                    resultDiv.innerHTML = `<strong>Error de autenticación:</strong> ${error.message}<br>`;
                    resultDiv.innerHTML += 'Verificar credenciales e intente nuevamente.<br>';
                    resultDiv.innerHTML += 'Si el problema persiste, ejecute el diagnóstico para más detalles.';
                });
            });
            
            // Verificar servidor
            document.getElementById('checkServer').addEventListener('click', function() {
                const statusDiv = document.getElementById('serverStatus');
                statusDiv.style.display = 'block';
                statusDiv.textContent = 'Verificando servidor...';
                
                fetch(`${baseUrl}/public/diagnostic/health`)
                    .then(response => response.json())
                    .then(data => {
                        statusDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    })
                    .catch(error => {
                        statusDiv.textContent = `Error al verificar servidor: ${error.message}`;
                    });
            });
            
            // Verificar CORS
            document.getElementById('checkCors').addEventListener('click', function() {
                const corsDiv = document.getElementById('corsStatus');
                corsDiv.style.display = 'block';
                corsDiv.textContent = 'Verificando configuración CORS...';
                
                fetch(`${baseUrl}/public/diagnostic/cors`)
                    .then(response => response.json())
                    .then(data => {
                        corsDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    })
                    .catch(error => {
                        corsDiv.textContent = `Error al verificar CORS: ${error.message}`;
                    });
            });
            
            // Verificar autenticación
            document.getElementById('checkAuth').addEventListener('click', function() {
                const authDiv = document.getElementById('authStatus');
                authDiv.style.display = 'block';
                authDiv.textContent = 'Verificando autenticación...';
                
                const token = localStorage.getItem('auth_token');
                
                if (!token) {
                    authDiv.innerHTML = 'No hay token de autenticación en localStorage.<br>';
                    authDiv.innerHTML += 'Inicie sesión primero para verificar la autenticación.';
                    return;
                }
                
                const headers = { 'Authorization': `Bearer ${token}` };
                
                fetch(`${baseUrl}/public/diagnostic/auth-info`, { headers })
                    .then(response => response.json())
                    .then(data => {
                        authDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                        
                        // Verificar además el usuario local
                        const user = localStorage.getItem('current_user');
                        if (user) {
                            try {
                                const userData = JSON.parse(user);
                                authDiv.innerHTML += '<br><strong>Usuario en localStorage:</strong><br>';
                                authDiv.innerHTML += `<pre>${JSON.stringify(userData, null, 2)}</pre>`;
                            } catch (e) {
                                authDiv.innerHTML += '<br>Error al parsear usuario en localStorage.';
                            }
                        }
                    })
                    .catch(error => {
                        authDiv.textContent = `Error al verificar autenticación: ${error.message}`;
                    });
            });
            
            // Limpiar localStorage
            document.getElementById('clearLocalStorage').addEventListener('click', function() {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('current_user');
                alert('localStorage limpiado exitosamente.');
            });
            
            // Limpiar cookies
            document.getElementById('clearCookies').addEventListener('click', function() {
                document.cookie.split(";").forEach(function(c) {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });
                alert('Cookies limpiadas exitosamente.');
            });
            
            // Ejecutar diagnóstico completo
            document.getElementById('diagnosisButton').addEventListener('click', async function() {
                const resultDiv = document.getElementById('loginResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<strong>Ejecutando diagnóstico completo...</strong><br>';
                
                try {
                    // 1. Verificar servidor
                    resultDiv.innerHTML += '1. Verificando estado del servidor...<br>';
                    let serverResponse = await fetch(`${baseUrl}/public/diagnostic/health`).catch(e => ({ error: e }));
                    
                    // 2. Verificar CORS
                    resultDiv.innerHTML += '2. Verificando configuración CORS...<br>';
                    let corsResponse = await fetch(`${baseUrl}/public/diagnostic/cors`).catch(e => ({ error: e }));
                    
                    // 3. Verificar autenticación actual
                    resultDiv.innerHTML += '3. Verificando información de autenticación...<br>';
                    let token = localStorage.getItem('auth_token');
                    let headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                    let authResponse = await fetch(`${baseUrl}/public/diagnostic/auth-info`, { headers }).catch(e => ({ error: e }));
                    
                    // 4. Recopilar información del navegador
                    resultDiv.innerHTML += '4. Recopilando información del navegador...<br>';
                    let browserInfo = {
                        userAgent: navigator.userAgent,
                        localStorage: {
                            token: token ? 'Presente' : 'Ausente',
                            user: localStorage.getItem('current_user') ? 'Presente' : 'Ausente'
                        },
                        hasCookies: document.cookie.length > 0
                    };
                    
                    // Construir reporte completo
                    resultDiv.innerHTML = '<strong>Reporte de diagnóstico completo:</strong><br><br>';
                    
                    resultDiv.innerHTML += '<strong>1. Estado del servidor:</strong><br>';
                    if (serverResponse.error) {
                        resultDiv.innerHTML += `<span style="color: red">Error: ${serverResponse.error.message}</span><br>`;
                    } else if (serverResponse.ok) {
                        const serverData = await serverResponse.json();
                        resultDiv.innerHTML += `<span style="color: green">Servidor OK</span><br>`;
                        resultDiv.innerHTML += `<pre>${JSON.stringify(serverData, null, 2)}</pre>`;
                    } else {
                        resultDiv.innerHTML += `<span style="color: orange">Respuesta inesperada: ${serverResponse.status}</span><br>`;
                    }
                    
                    resultDiv.innerHTML += '<br><strong>2. Configuración CORS:</strong><br>';
                    if (corsResponse.error) {
                        resultDiv.innerHTML += `<span style="color: red">Error: ${corsResponse.error.message}</span><br>`;
                        resultDiv.innerHTML += 'Posible problema de CORS. Verifique la configuración del servidor.<br>';
                    } else if (corsResponse.ok) {
                        const corsData = await corsResponse.json();
                        resultDiv.innerHTML += `<span style="color: green">CORS OK</span><br>`;
                        resultDiv.innerHTML += `<pre>${JSON.stringify(corsData, null, 2)}</pre>`;
                    } else {
                        resultDiv.innerHTML += `<span style="color: orange">Respuesta inesperada: ${corsResponse.status}</span><br>`;
                    }
                    
                    resultDiv.innerHTML += '<br><strong>3. Información de autenticación:</strong><br>';
                    if (authResponse.error) {
                        resultDiv.innerHTML += `<span style="color: red">Error: ${authResponse.error.message}</span><br>`;
                    } else if (authResponse.ok) {
                        const authData = await authResponse.json();
                        resultDiv.innerHTML += `<pre>${JSON.stringify(authData, null, 2)}</pre>`;
                    } else {
                        resultDiv.innerHTML += `<span style="color: orange">Respuesta inesperada: ${authResponse.status}</span><br>`;
                    }
                    
                    resultDiv.innerHTML += '<br><strong>4. Información del navegador:</strong><br>';
                    resultDiv.innerHTML += `<pre>${JSON.stringify(browserInfo, null, 2)}</pre>`;
                    
                    // Recomendaciones basadas en el diagnóstico
                    resultDiv.innerHTML += '<br><strong>Recomendaciones:</strong><br><ul>';
                    
                    if (serverResponse.error) {
                        resultDiv.innerHTML += '<li>Verificar que el servidor Spring Boot esté en ejecución</li>';
                        resultDiv.innerHTML += '<li>Comprobar la URL del servidor en el archivo environment.ts</li>';
                    }
                    
                    if (corsResponse.error) {
                        resultDiv.innerHTML += '<li>Verificar configuración CORS en ImprovementSolutionsApplication.java</li>';
                        resultDiv.innerHTML += '<li>Comprobar que allowedOrigins incluya "http://localhost:4200"</li>';
                    }
                    
                    if (token && authResponse.error) {
                        resultDiv.innerHTML += '<li>El token JWT puede ser inválido. Limpie localStorage e intente nuevamente</li>';
                    }
                    
                    if (!token) {
                        resultDiv.innerHTML += '<li>No hay token de autenticación. Inicie sesión primero</li>';
                    }
                    
                    resultDiv.innerHTML += '</ul>';
                    
                } catch (error) {
                    resultDiv.innerHTML += `<br><span style="color: red">Error durante el diagnóstico: ${error.message}</span>`;
                }
            });
        });
    </script>
</body>
</html>
